<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics | High-End Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <header class="bg-blue-600 text-white p-6 shadow-xl mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight">Sales Analytics BOSSai</h1>
                <p class="text-blue-100 opacity-80">Processing 69k+ Rows from Supabase</p>
            </div>
            <button onclick="fetchData()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-50 transition shadow-lg">
                ðŸ”„ Refresh Data
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-12">
        <div id="loading" class="text-center py-10 text-xl font-semibold animate-pulse">Calculating data... Please wait...</div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Total Revenue</p>
                <h2 id="kpi-revenue" class="text-2xl font-black text-blue-600">â‚¹0</h2>
            </div>
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Total Orders</p>
                <h2 id="kpi-orders" class="text-2xl font-black">0</h2>
            </div>
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Avg Order Value</p>
                <h2 id="kpi-aov" class="text-2xl font-black text-emerald-600">â‚¹0</h2>
            </div>
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Units Sold</p>
                <h2 id="kpi-units" class="text-2xl font-black text-orange-600">0</h2>
            </div>
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Unique Products</p>
                <h2 id="kpi-products" class="text-2xl font-black">0</h2>
            </div>
            <div class="glass-card p-4 rounded-xl shadow-sm border border-slate-200">
                <p class="text-xs uppercase text-slate-500 font-bold">Unique Brands</p>
                <h2 id="kpi-brands" class="text-2xl font-black text-purple-600">0</h2>
            </div>
        </div>

        <div class="flex border-b border-slate-200 mb-8 overflow-x-auto whitespace-nowrap">
            <button onclick="showTab('executive')" id="tab-btn-executive" class="px-6 py-3 tab-active">Executive</button>
            <button onclick="showTab('brands')" id="tab-btn-brands" class="px-6 py-3 text-slate-500">Brands</button>
            <button onclick="showTab('products')" id="tab-btn-products" class="px-6 py-3 text-slate-500">Products</button>
            <button onclick="showTab('platforms')" id="tab-btn-platforms" class="px-6 py-3 text-slate-500">Platforms</button>
        </div>

        <div id="tab-executive" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="font-bold mb-4">Yearly Revenue Trend</h3>
                <div class="chart-container"><canvas id="chart-yearly"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="font-bold mb-4">Platform Share</h3>
                <div class="chart-container"><canvas id="chart-platform"></canvas></div>
            </div>
        </div>

        <div id="tab-brands" class="tab-content hidden space-y-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
                <h3 class="font-bold mb-4 text-blue-600 uppercase tracking-widest text-sm">Brand Performance Leaderboard</h3>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b text-slate-400 text-xs uppercase">
                            <th class="py-3 px-4">Brand</th>
                            <th>Revenue</th>
                            <th>Orders</th>
                            <th>Units</th>
                        </tr>
                    </thead>
                    <tbody id="brand-table-body" class="text-sm"></tbody>
                </table>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="font-bold mb-4 text-blue-600 uppercase tracking-widest text-sm">Top 15 Brands Analysis</h3>
                <div class="chart-container" style="height: 500px;"><canvas id="chart-brands-bar"></canvas></div>
            </div>
        </div>

        <div id="tab-products" class="tab-content hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="font-bold mb-4">Top 10 Products by Revenue</h3>
                <div class="chart-container" style="height: 400px;"><canvas id="chart-products"></canvas></div>
            </div>
        </div>

        <div id="tab-platforms" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="font-bold mb-4 text-blue-600 uppercase tracking-widest text-sm">B2B vs B2C Split</h3>
                <div class="chart-container"><canvas id="chart-channel"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="font-bold mb-4 text-blue-600 uppercase tracking-widest text-sm">Marketplace Performance</h3>
                <div class="chart-container"><canvas id="chart-marketplace-bar"></canvas></div>
            </div>
        </div>
    </main>

    <script>
        // CONFIGURATION - PASTE YOUR KEYS HERE
        const SUPABASE_URL = 'https://qhofzqnjvmahrmhsaibk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFob2Z6cW5qdm1haHJtaHNhaWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjA2MzEsImV4cCI6MjA4NTU5NjYzMX0.Cju4JG-RMzVZwI4AO7TbfL4O8L8Rj-4-MCwQ6xuBRu0';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let charts = {};

        async function fetchData() {
    document.getElementById('loading').classList.remove('hidden');
            
            // This matches your SQL table column names exactly
    const { data, error } = await supabase
        .from('sales')
        .select('year, marketplace, channel_type, brand, sku, total_sales, quantity, order_id');

    if (error) {
        console.error("Error fetching data:", error);
        document.getElementById('loading').innerText = "Error: " + error.message;
        return;
    }

    if (data.length === 0) {
        document.getElementById('loading').innerText = "No data found in 'sales' table.";
        return;
    }

    calculateKPIs(data);
    renderCharts(data);
    document.getElementById('loading').classList.add('hidden');
}

        function calculateKPIs(data) {
            const revenue = data.reduce((sum, row) => sum + (row.total_sales || 0), 0);
            const orders = [...new Set(data.map(row => row.order_id))].length || data.length; // Fallback to row count if order_id is missing
            const units = data.reduce((sum, row) => sum + (row.quantity || 0), 0);
            const products = new Set(data.map(row => row.sku)).size;
            const brands = new Set(data.map(row => row.brand)).size;

            document.getElementById('kpi-revenue').innerText = 'â‚¹' + revenue.toLocaleString('en-IN');
            document.getElementById('kpi-orders').innerText = orders.toLocaleString();
            document.getElementById('kpi-aov').innerText = 'â‚¹' + Math.round(revenue / orders).toLocaleString('en-IN');
            document.getElementById('kpi-units').innerText = units.toLocaleString();
            document.getElementById('kpi-products').innerText = products.toLocaleString();
            document.getElementById('kpi-brands').innerText = brands.toLocaleString();
        }

        function renderCharts(data) {
            // Logic for aggregation (Brands, Years, etc.)
            const brandsRev = {};
            const yearsRev = {};
            const platformsRev = {};
            const channelsRev = {};
            const skuRev = {};

            data.forEach(row => {
                yearsRev[row.year] = (yearsRev[row.year] || 0) + row.total_sales;
                platformsRev[row.marketplace] = (platformsRev[row.marketplace] || 0) + row.total_sales;
                channelsRev[row.channel_type] = (channelsRev[row.channel_type] || 0) + row.total_sales;
                brandsRev[row.brand] = (brandsRev[row.brand] || 0) + row.total_sales;
                skuRev[row.sku] = (skuRev[row.sku] || 0) + row.total_sales;
            });

            // Tab 1: Yearly Bar
            createChart('chart-yearly', 'bar', Object.keys(yearsRev), Object.values(yearsRev), '#3b82f6');
            
            // Tab 1: Platform Pie
            createChart('chart-platform', 'doughnut', Object.keys(platformsRev), Object.values(platformsRev), ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']);

            // Tab 2: Brand List & Charts
            const sortedBrands = Object.entries(brandsRev).sort((a,b) => b[1] - a[1]);
            renderBrandTable(sortedBrands.slice(0, 20), data);
            createChart('chart-brands-bar', 'bar', sortedBrands.slice(0, 15).map(x => x[0]), sortedBrands.slice(0, 15).map(x => x[1]), '#8b5cf6', true);

            // Tab 3: Products
            const sortedSKU = Object.entries(skuRev).sort((a,b) => b[1] - a[1]);
            createChart('chart-products', 'bar', sortedSKU.slice(0, 10).map(x => x[0]), sortedSKU.slice(0, 10).map(x => x[1]), '#f59e0b', true);

            // Tab 4: Channels
            createChart('chart-channel', 'pie', Object.keys(channelsRev), Object.values(channelsRev), ['#0ea5e9', '#ec4899']);
            createChart('chart-marketplace-bar', 'bar', Object.keys(platformsRev), Object.values(platformsRev), '#10b981');
        }

        function createChart(id, type, labels, values, color, horizontal = false) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: color,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: horizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type === 'doughnut' || type === 'pie' } }
                }
            });
        }

        function renderBrandTable(topBrands, rawData) {
            const body = document.getElementById('brand-table-body');
            body.innerHTML = '';
            topBrands.forEach(([name, rev]) => {
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-slate-50";
                row.innerHTML = `
                    <td class="py-3 px-4 font-bold">${name}</td>
                    <td>â‚¹${rev.toLocaleString('en-IN')}</td>
                    <td>${rawData.filter(r => r.brand === name).length}</td>
                    <td>${rawData.filter(r => r.brand === name).reduce((s,r) => s+r.quantity, 0)}</td>
                `;
                body.appendChild(row);
            });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'text-blue-600'));
            
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('tab-btn-' + tabId).classList.add('tab-active');
        }

        // Initialize
        fetchData();
    </script>
</body>
</html>
